steps:
  # Instalar dependencias
  - name: "python:3.11"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        pip install -r requirements.txt --break-system-packages
        pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client --break-system-packages
    id: "install-deps"

  # Descargar data.json desde Google Drive
  - name: "python:3.11"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        ls -la
        echo "Ejecutando download_data.py..."
        python download_data.py
        echo "âœ… Descarga completada"
        ls -la data.json
    secretEnv: ["GOOGLE_DRIVE_CREDENTIALS"]
    id: "download-data"
    waitFor: ["install-deps"]

  # Ejecutar scripts segÃºn _SCRIPTS variable
  - name: "python:3.11"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        IFS=',' read -ra SCRIPT_ARRAY <<< "${_SCRIPTS}"
        
        for script_num in "$${SCRIPT_ARRAY[@]}"; do
          case $$script_num in
            1)
              echo "ðŸš€ Ejecutando script 1: Obtener URLs"
              python 1_obtenerurls.py
              ;;
            2)
              echo "ðŸ¤– Ejecutando script 2: Extraer info con IA"
              python 2_extraerinfovideospotenciales.py
              ;;
            3)
              echo "ðŸ“± Ejecutando script 3: Notificar a Telegram"
              python 3_notificar_descartados.py
              ;;
            4)
              echo "âœï¸ Ejecutando script 4: Cambiar status"
              if [ -n "${_TELEGRAM_IDS}" ]; then
                python 4_cambiar_status.py "${_TELEGRAM_IDS}"
              else
                echo "âš ï¸ No se proporcionaron IDs de Telegram"
              fi
              ;;
            5)
              echo "ðŸ§¹ Ejecutando script 5: Limpiar no seleccionados"
              python 5_limpiar_no_seleccionados.py
              ;;
            *)
              echo "âš ï¸ Script $$script_num no reconocido"
              ;;
          esac
        done
    env:
      - "TELEGRAM_BOT_TOKEN=${_TELEGRAM_BOT_TOKEN}"
      - "TELEGRAM_CHAT_ID=${_TELEGRAM_CHAT_ID}"
    id: "run-scripts"
    waitFor: ["download-data"]

  # Subir data.json actualizado a Google Drive
  - name: "python:3.11"
    entrypoint: "python"
    args: ["upload_data.py"]
    secretEnv: ["GOOGLE_DRIVE_CREDENTIALS"]
    id: "upload-data"
    waitFor: ["run-scripts"]

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/GOOGLE_DRIVE_CREDENTIALS/versions/latest
      env: "GOOGLE_DRIVE_CREDENTIALS"

substitutions:
  _SCRIPTS: "1,2,3"
  _TELEGRAM_IDS: ""
  _TELEGRAM_BOT_TOKEN: "8088691958:AAHrOjGVJrvOgbU30rLY23HPmrrNNKYHDUo"
  _TELEGRAM_CHAT_ID: "8088691958"

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: "N1_HIGHCPU_8"